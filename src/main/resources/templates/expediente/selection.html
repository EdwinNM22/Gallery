<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  th:lang="${#locale.language}"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="Bio/vizion Project Management System" />
    <meta name="author" content="Bio/vizion" />

    <title th:text="#{evaluation-form-title}">
      Bio/vizion - Fiche d'Évaluation – Conduits de Ventilation
    </title>

    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="/css/form.css" rel="stylesheet" />
    <link href="/css/expediente/selection.css" rel="stylesheet" />

    <link href="/css/daypilot.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="bg-fast-load">
      <img src="/img/admrescale.webp" alt="" decoding="async" />
    </div>

    <div class="main-container">
      <div class="container">
        <div class="hero-section animated">
          <h1 class="hero-title" th:text="#{evaluation-form-title}">
            Fiche d'Évaluation – Conduits de Ventilation
          </h1>
        </div>

        <div th:if="${success}" class="alert alert-success" role="alert">
          <i class="fas fa-check-circle"></i>
          <span th:text="${message}">Message de réussite</span>
        </div>

        <div th:if="${error}" class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-circle"></i>
          <span th:text="${message}">Message d'erreur</span>
        </div>

        <div class="btn-container">
          <a class="btn btn-back" th:href="@{/expediente}">
            <i class="fas fa-arrow-left"></i>
            <span th:text="#{back-to-files}">Back to Files</span>
          </a>
        </div>

        <div class="projects-container">
          <div class="projects-buttons">
            <div class="album-card antes">
              <div class="album-card-content">
                <h3>
                  <span th:text="#{completed-projects}"
                    >Proyectos Completados</span
                  >
                </h3>
                <p th:text="#{all-completed-projects}">
                  Todos los proyectos completados
                </p>
                <div class="album-card-footer">
                  <a
                    th:href="@{/form/manage/{usuarioId}/{expedienteId}(usuarioId=${session.idusuario}, expedienteId=${expedienteId})}"
                    class="btn-view"
                  >
                    <i class="fas fa-eye"></i>
                    <span th:text="#{view}">View</span>
                  </a>
                </div>
              </div>
            </div>
            <div class="album-card despues">
              <div class="album-card-content">
                <h3>
                  <span th:text="#{future-projects}">Proyectos Futuros</span>
                </h3>
                <p th:text="#{all-future-projects}">
                  Todos los proyectos futuros
                </p>
                <div class="album-card-footer">
                  <a
                    th:href="@{/expediente/manage-future-projects/{usuarioId}/{expedienteId} (usuarioId=${session.idusuario}, expedienteId=${expedienteId})}"
                    class="btn-view"
                  >
                    <i class="fas fa-eye"></i>
                    <span th:text="#{view}">View</span>
                  </a>
                </div>
              </div>
            </div>
          </div>

          <div class="calendar-section">
            <div class="calendar-container">
              <div class="calendar-controls">
                <button id="prev-month" class="btn-control">
                  <i class="fas fa-chevron-left"></i>
                  <span th:text="#{previous}">Previous</span>
                </button>
                <button id="today" class="btn-control active">
                  <i class="fas fa-calendar-day"></i>
                  <span th:text="#{today}">Today</span>
                </button>
                <button id="next-month" class="btn-control">
                  <span th:text="#{next}">Next</span>
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
              <div class="calendar-wrapper">
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/daypilot/daypilot-all.min.js"></script>
    <script th:inline="javascript">
      // --- Funcion para procesar eventos ---
      function processEventData(events, cssClass = "daypilot-event-badge in-progress") {
        const results = [];

        events.forEach((ev) => {
          const startDate = new Date(ev.start);
          let endDate = ev.end ? new Date(ev.end) : new Date(ev.start);
          endDate.setDate(endDate.getDate() + 1);

          if (startDate.toDateString() !== endDate.toDateString()) {
            const currentDate = new Date(startDate);

            while (currentDate < endDate) {
              const eventDate = new Date(currentDate);
              const eventEndDate = new Date(currentDate);
              eventEndDate.setDate(eventEndDate.getDate() + 1);

              results.push({
                id: `${ev.id}-${eventDate.toISOString().split('T')[0]}`,
                start: eventDate,
                end: eventEndDate,
                text: ev.nombreCliente,
                barVisible: false,
                backColor: "transparent",
                borderColor: "transparent",
                moveDisabled: true,
                resizeDisabled: true,
                cssClass: cssClass,
                tags: {
                  nombreCliente: ev.nombreCliente,
                  originalEventId: ev.id,
                  estado: cssClass.includes('complete') ? 'complete' : 'in-progress',
                }
              });

              currentDate.setDate(currentDate.getDate() + 1);
            }
          } else {
            results.push({
              id: ev.id,
              start: ev.start,
              end: ev.end,
              text: ev.nombreCliente,
              barVisible: false,
              backColor: "transparent",
              borderColor: "transparent",
              moveDisabled: true,
              resizeDisabled: true,
              cssClass: cssClass,
              tags: {
                nombreCliente: ev.nombreCliente,
                originalEventId: ev.id,
                estado: cssClass.includes('complete') ? 'complete' : 'in-progress',
              }
            });
          }
        });

        return results;
      }

      // --- Calendario ---

      /*<![CDATA[*/
      var expedienteId = [[${expedienteId}]];
      const proyectosNombresFechas = /*[[${events}]]*/ [];
      const proyectosNombresFechasCompletos = /*[[${eventsComplete}]]*/ [];

      // Configuración del calendario con los estilos personalizados
      const dp = new DayPilot.Month("calendar", {
        theme: "calendar",
        showWeekends: true,
        headerDateFormat: "MMMM yyyy",
        eventArrangement: "SideBySideStack",
        headerClickHandling: "Enabled",
        headerNavigationEnabled: true,
        timeRangeSelectHandling: "Enabled",
        selectMode: "Day",
        heightSpec: "Fixed",
        height: 600,
        width: "100%",
        onTimeRangeSelected: async (args) => {
          const clickedDate = args.start.toString("yyyy-MM-dd");
          window.location.href = `/expediente/create-future-project?expedienteId=${expedienteId}&fecha_evaluacion=${clickedDate}`;
        },
        eventClickHandling: "Enabled",
        onEventClick: async (args) => {
          const eventId = args.e.data.tags.originalEventId;
          const isComplete = args.e.data.tags.estado === 'complete';

          const redirectUrl = isComplete ? `/form/${eventId}` : `/expediente/view-future-project/${eventId}`

          window.location.href = redirectUrl;
        },
        eventMoveHandling: "Disabled",
        eventResizeHandling: "Disabled",
        timeRangeDoubleClickHandling: "Disabled",
        eventRightClickHandling: "Disabled",
        eventHeight: 25,
        cellHeight: 120,
        eventStackingLineHeight: 24
      });

      const processedEvents = [
      ...processEventData(proyectosNombresFechas, "daypilot-event-badge in-progress"),
      ...processEventData(proyectosNombresFechasCompletos, "daypilot-event-badge completed")
      ];

      dp.events.list = processedEvents;
      dp.init();

      // Controles de navegación
      document.getElementById("prev-month").addEventListener("click", () => {
        dp.startDate = dp.startDate.addMonths(-1);
        dp.update();
      });

      document.getElementById("today").addEventListener("click", () => {
        dp.startDate = new DayPilot.Date();
        dp.update();
      });

      document.getElementById("next-month").addEventListener("click", () => {
        dp.startDate = dp.startDate.addMonths(1);
        dp.update();
      });
      /*]]>*/
    </script>
  </body>
</html>
