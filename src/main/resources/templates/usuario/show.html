<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <meta name="description" content="Gestión de Permisos de Usuario - Administración"/>
  <meta name="author" content="" />

  <title th:text="#{permission-management}">Permission Management</title>

  <!-- Bootstrap core CSS -->
  <link th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Preload -->
  <link
          rel="preload"
          as="image"
          href="/img/upscalemedia-transformed.webp?width=1200"
          imagesrcset="/img/upscalemedia-transformed.webp?width=600 600w, /img/upscalemedia-transformed.webp?width=1200 1200w, /img/upscalemedia-transformed.webp?width=1800 1800w"
          imagesizes="100vw"
  />

  <style>
    :root {
      --primary-blue: #2c5aa0;
      --accent-blue: #3a7bd5;
      --dark-bg: #0f1923;
      --darker-bg: #0a121a;
      --light-text: #e0e0e0;
      --lighter-text: #ffffff;
      --border-color: rgba(44, 90, 160, 0.3);
      --card-bg: rgba(15, 25, 35, 0.85);
      --success-color: #4cc9f0;
      --danger-color: #ff4d4d;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
    }

    body {
      font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--light-text);
      background-color: rgba(0, 0, 0, 0.94);
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
    }

    .bg-fast-load {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      overflow: hidden;
    }

    .bg-fast-load img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.5;
    }

    .container {
      padding-top: 2rem;
      padding-bottom: 4rem;
    }

    /* Header styles mejorado */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
      z-index: 1;
    }

    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--lighter-text);
      margin-bottom: 1rem;
      position: relative;
      display: inline-block;
    }

    .page-header h1:after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      border-radius: 3px;
    }

    .breadcrumb {
      background-color: transparent;
      padding: 0.5rem 0;
    }

    .breadcrumb-item {
      color: var(--light-text);
    }

    .breadcrumb-item a {
      color: var(--accent-blue);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    .breadcrumb-item a:hover {
      color: var(--lighter-text);
      text-decoration: underline;
    }

    /* Card styles mejorado */
    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(5px);
    }

    .card-header {
      background: linear-gradient(90deg, var(--darker-bg), var(--dark-bg));
      color: var(--lighter-text);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }

    /* Table styles mejorado */
    .table {
      color: var(--light-text);
      margin-bottom: 0;
    }

    .table th {
      background: rgba(15, 25, 35, 0.9);
      color: var(--lighter-text);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      padding: 1rem;
    }

    .table td {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      background: rgba(15, 25, 35, 0.5);
      vertical-align: middle;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(44, 90, 160, 0.1);
    }

    /* Button styles mejorado */
    .btn-container {
      display: flex;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
    }

    .btn-back {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow: hidden;
      z-index: 1;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
      color: var(--light-text);
      text-align: center;
    }

    .btn-back:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(58, 123, 213, 0.2);
      color: var(--lighter-text);
      border-color: transparent;
    }

    /* Botones de acción mejorados */
    .btn-action-group {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      border-radius: 6px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(5px);
      min-width: 100px;
    }

    .btn-sm:hover {
      color: var(--lighter-text) !important;
    }

    .change-password-btn {
      background: rgba(23, 162, 184, 0.2);
      color: var(--info-color);
      border-color: rgba(23, 162, 184, 0.5);
    }

    .change-password-btn:hover {
      background: rgba(23, 162, 184, 0.3);
      border-color: var(--info-color);
    }

    .delete-btn {
      background: rgba(255, 77, 77, 0.2);
      color: var(--danger-color);
      border-color: rgba(255, 77, 77, 0.5);
    }

    .delete-btn:hover {
      background: rgba(255, 77, 77, 0.3);
      border-color: var(--danger-color);
    }

    .info-btn {
      background: rgba(44, 90, 160, 0.2);
      color: var(--primary-blue);
      border-color: rgba(44, 90, 160, 0.5);
    }

    .info-btn:hover {
      background: rgba(44, 90, 160, 0.3);
      border-color: var(--primary-blue);
    }

    .btn-sm i {
      margin-right: 5px;
      color: inherit;
    }

    /* User info styles mejorado */
    .user-name {
      font-weight: 600;
      color: var(--lighter-text);
    }

    .user-email {
      color: var(--accent-blue);
      word-break: break-word;
    }

    .supervisorplus-star {
      color: var(--warning-color);
      margin-left: 5px;
    }

    /* Badges mejorado */
    .badge-count {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--light-text);
      font-weight: 600;
      padding: 0.5rem 0.8rem;
      border-radius: 50px;
    }

    /* Alerts mejorado */
    .alert {
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      border: 1px solid transparent;
      backdrop-filter: blur(5px);
    }

    .alert-success {
      background-color: rgba(76, 201, 240, 0.1);
      border-color: var(--success-color);
      color: var(--light-text);
    }

    .alert-danger {
      background-color: rgba(255, 77, 77, 0.1);
      border-color: var(--danger-color);
      color: var(--light-text);
    }

    /* Modal styles mejorado */
    .modal-content {
      border-radius: 8px;
      border: none;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      background-color: var(--darker-bg);
      color: var(--light-text);
    }

    .modal-header {
      background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
      color: var(--lighter-text);
      border-radius: 8px 8px 0 0;
      border: none;
      padding: 1.2rem;
    }

    .modal-title {
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .modal-title i {
      margin-right: 10px;
    }

    .modal-body {
      padding: 1.5rem;
      background-color: var(--dark-bg);
    }

    .modal-footer {
      border-top: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
      background-color: var(--darker-bg);
    }

    .user-info-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .user-info-label {
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 0.5rem;
    }

    .user-info-value {
      color: var(--light-text);
      word-break: break-word;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 2rem;
      }

      .btn-container {
        flex-direction: column;
      }

      .btn-back {
        width: 100%;
      }
    }

    @media (max-width: 576px) {
      .page-header h1 {
        font-size: 1.8rem;
      }

      /* Mobile table styles */
      table {
        display: block;
        width: 100%;
      }

      thead {
        display: none;
      }

      tbody {
        display: block;
        width: 100%;
      }

      tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        background: rgba(15, 25, 35, 0.7);
      }

      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem;
        border: none;
        border-bottom: 1px solid var(--border-color);
        background: transparent;
      }

      td:last-child {
        border-bottom: none;
        padding-top: 1rem;
        justify-content: center;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        margin-right: 1rem;
        color: var(--light-text);
        flex: 1;
      }

      td > *:not(::before) {
        flex: 2;
        text-align: right;
      }

      /* Actions column */
      td[data-label="Actions"] {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        padding-top: 1rem;
      }

      td[data-label="Actions"]::before {
        display: none;
      }

      /* Hide text in buttons on mobile, show only icons */
      .btn-sm span {
        display: none;
      }

      .btn-sm i {
        margin-right: 0 !important;
      }

      .btn-action-group {
        justify-content: center;
        width: 100%;
      }
    }
    /* Corregir inputs blancos y ojos mal posicionados en modal */
    .password-input-group {
      position: relative;
    }

    .password-input-group input {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--light-text);
      border: 1px solid var(--border-color);
      padding-right: 40px; /* espacio para el ícono */
    }

    .password-input-group .toggle-password {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      color: var(--light-text);
      cursor: pointer;
      font-size: 1rem;
    }

    @media (max-width: 576px) {
      .btn-sm {
        width: 100%;
        justify-content: center;
        padding: 1rem 1rem !important;     /* Aumenta la altura */
        font-size: 1.1rem;
        min-height: 48px;                  /* Altura mínima clara */
      }

      .btn-action-group {
        flex-direction: column;
        gap: 0.75rem;
        align-items: stretch;
      }
    }


  </style>
</head>

<body>
<div th:replace="fragments/navbar :: navbar"></div>

<!-- Imagen -->
<div class="bg-fast-load">
  <img
          src="/img/upscalemedia-transformed.webp"
          srcset="
          /img/upscalemedia-transformed.webp?width=600   600w,
          /img/upscalemedia-transformed.webp?width=1200 1200w,
          /img/upscalemedia-transformed.webp?width=1800 1800w
        "
          sizes="100vw"
          alt=""
          decoding="async"
  />
</div>

<!-- Page Content -->
<div class="container">
  <!-- Page Heading -->
  <div class="page-header">
    <h1 class="mb-2">
      <i class="fas fa-user-cog mr-2"></i
      ><span th:text="#{permission-management}">Permission Management</span>
    </h1>
  </div>

  <!-- Mensajes de retroalimentación -->
  <div
          th:if="${successMessage}"
          class="alert alert-success alert-dismissible fade show"
          role="alert"
  >
    <span th:text="${successMessage}"></span>
    <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div
          th:if="${errorMessage}"
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
  >
    <span th:text="${errorMessage}"></span>
    <button
            type="button"
            class="close"
            data-dismiss="alert"
            aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <!-- Botones de acción -->
  <div class="btn-container">
    <a class="btn btn-back" th:href="@{/adm}">
      <i class="fas fa-arrow-left"></i>
      <span th:text="#{back-to-menu}">Back to Menu</span>
    </a>
  </div>

  <div th:replace="permiso/permissions-panel :: panelPermisos"></div>

  <!--usuarios -->
  <div class="card">
    <div
            class="card-header d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0">
        <i class="fas fa-users mr-2"></i
        ><span th:text="#{users}">Users</span>
      </h5>
      <span
              class="badge badge-light"
              th:text="#{total-users(${#lists.size(usuarios)})}"
      >Total: 0</span
      >
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
          <tr>
            <th th:text="#{name}">Name</th>
            <th th:text="#{email}">Email</th>
            <th th:text="#{actions}">Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="usuario, stat : ${usuarios}">
            <td data-label="Nombre" th:data-label="#{name}">
              <div class="user-name" th:text="${usuario.nombre}"></div>
            </td>
            <td data-label="Email" th:data-label="#{email}">
              <div
                      class="user-email"
                      th:text="${usuario.email} ?: #{no-email}"
              ></div>
            </td>

            <td data-label="Actions">
              <button
                      type="button"
                      class="btn btn-sm info-btn mr-2"
                      th:attr="data-id=${usuario.id}, data-name=${usuario.nombre}, data-email=${usuario.email}, data-password=${usuario.passwordSinEncriptar}">

                <i class="fas fa-info-circle"></i>
                <span class="d-none d-md-inline" th:text="#{info}"
                >Info</span
                >
              </button>

              <button
                      type="button"
                      class="btn btn-sm change-password-btn mr-2"
                      th:attr="data-id=${usuario.id}, data-name=${usuario.nombre}"
                      th:if="${USUARIOS_EDIT_PASSWORD}"
              >
                <i class="fas fa-key"></i>
                <span class="d-none d-md-inline" th:text="#{password}"
                >Password</span
                >
              </button>

              <form
                      th:action="@{/usuario/delete}"
                      method="post"
                      th:id="${'delete-form-' + usuario.id}"
                      style="display: inline"
              >
                <input type="hidden" name="id" th:value="${usuario.id}" />

                <button
                        type="button"
                        class="btn btn-sm delete-btn"
                        th:attr="data-id=${usuario.id}, data-name=${usuario.nombre}"
                        th:if="${USUARIOS_DELETE}"
                >
                  <i class="fas fa-trash-alt"></i>
                  <span class="d-none d-md-inline" th:text="#{delete}"
                  >Delete</span
                  >
                </button>
              </form>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para cambiar contraseña -->
<div
        class="modal fade"
        id="changePasswordModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="changePasswordModalLabel"
        aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLabel">
          <span th:text="#{change-password}">Change Password</span>
        </h5>
        <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form
              id="changePasswordForm"
              th:action="@{/usuario/changePassword}"
              method="post"
      >
        <input type="hidden" id="userId" name="id" />
        <div class="modal-body">
          <div th:if="${newPassword}" class="password-result">
            <h6 th:text="#{generated-password}">Generated Password:</h6>
            <div class="password-text" th:text="${newPassword}"></div>
            <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary copy-password-btn"
                    onclick="copyPassword()"
            >
              <i class="fas fa-copy"></i>
              <span th:text="#{copy-password}">Copy Password</span>
            </button>
            <small
                    th:text="password-warning"
                    class="text-muted d-block mt-2"
            >Save this password in a secure place. You won't be able to
              see it again.</small
            >
          </div>

          <div id="passwordFormFields">
            <div class="form-group">
              <label for="newPassword" th:text="#{new-password}"
              >Nueva Contraseña</label
              >
              <div class="password-input-group">
                <input
                        type="password"
                        class="form-control"
                        id="newPassword"
                        name="newPassword"
                        required
                />
                <i
                        class="fas fa-eye toggle-password"
                        onclick="togglePasswordVisibility('newPassword')"
                ></i>
              </div>
              <small class="form-text text-muted" th:text="#{password-hint}"
              >We recommend using a strong password with uppercase
                letters, numbers and special characters.</small
              >
            </div>
            <div class="form-group">
              <label th:text="#{confirm-password}" for="confirmPassword"
              >Confirmar Contraseña</label
              >
              <div class="password-input-group">
                <input
                        type="password"
                        class="form-control"
                        id="confirmPassword"
                        name="confirmPassword"
                        required
                />
                <i
                        class="fas fa-eye toggle-password"
                        onclick="togglePasswordVisibility('confirmPassword')"
                ></i>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
                  th:text="#{cancel}"
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
          >
            Cancelar
          </button>
          <button
                  th:text="#{save-changes}"
                  type="submit"
                  class="btn btn-primary"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para información de usuario -->
<div
        class="modal fade"
        id="userInfoModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="userInfoModalLabel"
        aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userInfoModalLabel">
          <i class="fas fa-user-circle mr-2"></i>
          <span th:text="#{user-info}">User Information</span>
        </h5>
        <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="user-info-item">
          <div class="user-info-label" th:text="#{name}">Name</div>
          <div class="user-info-value" id="infoUserName"></div>
        </div>

        <div class="user-info-item">
          <div class="user-info-label" th:text="#{email}">Email</div>
          <div class="user-info-value" id="infoUserEmail"></div>
        </div>
        <div class="user-info-item">
          <div class="user-info-label" th:text="#{password}">Password</div>
          <div class="user-info-value">
            <span id="infoUserPassword"></span>
            <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary ml-2"
                    onclick="copyToClipboard('infoUserPassword')"
            >
              <i class="fas fa-copy"></i>
              <span th:text="#{copy}">Copy</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal" th:text="#{close}">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<div th:replace="adm/template_admin.html :: footer"></div>

<!-- Bootstrap core JavaScript -->
<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Confirmación para eliminar usuario
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", function (e) {
        e.preventDefault();
        const userId = this.getAttribute("data-id");
        const userName = this.getAttribute("data-name");

        if (
                confirm(
                        `Are you sure you want to delete user ${userName}? This action cannot be undone.`
                )
        ) {
          const form = this.closest("form");
          if (form) {
            form.submit();
          } else {
            console.error("No se encontró el formulario de eliminación");
          }
        }
      });
    });

    // Manejar el modal de cambio de contraseña
    document.querySelectorAll(".change-password-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const userId = this.getAttribute("data-id");
        const userName = this.getAttribute("data-name");

        document.getElementById("userId").value = userId;
        document.getElementById(
                "changePasswordModalLabel"
        ).textContent = `Change Password - ${userName}`;

        $("#changePasswordModal").modal("show");
      });
    });

    // Manejar el modal de información de usuario
    document.querySelectorAll(".info-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const userName = this.getAttribute("data-name");
        const userEmail = this.getAttribute("data-email");
        const userPassword = this.getAttribute("data-password");

        document.getElementById("infoUserName").textContent = userName;
        document.getElementById("infoUserEmail").textContent = userEmail;
        document.getElementById("infoUserPassword").textContent = userPassword;

        $("#userInfoModal").modal("show");
      });
    });

    // Si hay una nueva contraseña en el modelo, mostramos el modal automáticamente
    if (document.querySelector(".password-result")) {
      $("#changePasswordModal").modal("show");
    }
  });

  // Función para copiar la contraseña al portapapeles
  function copyPassword() {
    const passwordText =
            document.querySelector(".password-text").textContent;
    navigator.clipboard
            .writeText(passwordText)
            .then(() => {
              const copyBtn = document.querySelector(".copy-password-btn");
              const originalHtml = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
              setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
              }, 2000);
            })
            .catch((err) => {
              console.error("Error al copiar: ", err);
            });
  }

  // Función para copiar texto al portapapeles
  function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).textContent;
    navigator.clipboard
            .writeText(text)
            .then(() => {
              const copyBtn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
              const originalHtml = copyBtn.innerHTML;
              copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
              setTimeout(() => {
                copyBtn.innerHTML = originalHtml;
              }, 2000);
            })
            .catch((err) => {
              console.error("Error al copiar: ", err);
            });
  }

  // Función para mostrar/ocultar contraseña
  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.querySelector(`#${inputId} + .toggle-password`);

    if (input.type === "password") {
      input.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      input.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }
</script>

<div th:replace="fragments/loader :: pantalla-carga"></div>

</body>
</html>