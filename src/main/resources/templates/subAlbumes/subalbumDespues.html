<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Bio/vizion Project Management System">
    <meta name="author" content="Bio/vizion">

    <title th:text="#{my-projects-title}">Photos - Bio/vizion Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts - Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Preload -->
    <link rel="preload"
          as="image"
          href="/img/album.webp?width=1200"
          imagesrcset="/img/album.webp?width=600 600w, /img/album.webp?width=1200 1200w, /img/album.webp?width=1800 1800w"
          imagesizes="100vw">

    <style>
        :root {
            --primary-blue: #2c5aa0;
            --accent-blue: #3a7bd5;
            --dark-bg: #0f1923;
            --darker-bg: #0a121a;
            --light-text: #e0e0e0;
            --lighter-text: #ffffff;
            --border-color: rgba(44, 90, 160, 0.3);
            --card-bg: rgba(15, 25, 35, 0.85);
            --success-color: #4cc9f0;
            --danger-color: #ff4d4d;
        }

        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--light-text);
            background-color: rgba(0, 0, 0, 0.94);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .bg-fast-load {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
        }

        .bg-fast-load img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.5;
        }

        .main-container {
            padding-top: 2rem;
            padding-bottom: 4rem;
        }

        /* Header styles */
        .hero-section {
            text-align: center;
            margin-bottom: 4rem;
            position: relative;
            z-index: 1;
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--lighter-text);
            margin-bottom: 1.5rem;
            position: relative;
            display: inline-block;
            letter-spacing: 1px;
        }

        .hero-title:after {
            content: '';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            border-radius: 3px;
        }

        .hero-subtitle {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.75);
            max-width: 700px;
            margin: 0 auto 2.5rem;
            line-height: 1.8;
            font-weight: 300;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1.2rem;
            margin-bottom: 3rem;
        }

        .btn-mega {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1.3rem 2rem;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            z-index: 1;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: var(--card-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            color: var(--light-text);
            text-align: center;
        }

        /* Button sizes */
        .btn-mega.btn-sm {
            padding: 0.8rem 1.2rem;
            font-size: 0.85rem;
        }

        /* Button variants */
        .btn-mega.btn-danger {
            background: rgba(255, 77, 77, 0.1);
            border-color: rgba(255, 77, 77, 0.3);
        }

        .btn-mega.btn-danger::before {
            background: linear-gradient(45deg, #ff4d4d, #cc0000);
        }

        .btn-mega.btn-danger:hover {
            box-shadow: 0 6px 12px rgba(255, 77, 77, 0.2);
        }

        .btn-mega.btn-success {
            background: rgba(76, 201, 240, 0.1);
            border-color: rgba(76, 201, 240, 0.3);
        }

        .btn-mega.btn-success::before {
            background: linear-gradient(45deg, var(--success-color), #20c997);
        }

        .btn-mega.btn-success:hover {
            box-shadow: 0 6px 12px rgba(76, 201, 240, 0.2);
        }

        .btn-mega::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary-blue), var(--accent-blue));
            z-index: -1;
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .btn-mega:hover::before {
            opacity: 1;
        }

        .btn-mega:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(58, 123, 213, 0.2);
            color: var(--lighter-text);
            border-color: transparent;
        }

        .btn-mega:active {
            transform: translateY(0);
        }

        .btn-icon {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 0 1.5rem;
            margin-bottom: 2rem;
        }

        /* Photo Card */
        .photo-card {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(58, 123, 213, 0.2);
            border-color: var(--primary-blue);
        }

        .photo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
        }

        .photo-card.selected {
            border: 2px solid var(--success-color);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.3);
        }

        .photo-img-container {
            position: relative;
            overflow: hidden;
            height: 200px;
        }

        .photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .photo-card:hover .photo-img {
            transform: scale(1.05);
        }

        .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            padding: 1rem;
            color: white;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .photo-card:hover .photo-overlay {
            transform: translateY(0);
        }

        .photo-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--lighter-text);
        }

        .photo-description {
            font-size: 0.9rem;
            opacity: 0.9;
            color: var(--light-text);
        }

        .photo-content {
            padding: 1rem;
        }

        .photo-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* Photo Checkbox */
        .photo-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        /* Download actions */
        .download-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .download-actions > div {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1rem;
        }

        #selectedCount {
            color: var(--light-text);
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Loading and Notifications */
        .download-loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .download-loading-content {
            background: var(--darker-bg);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            border: 1px solid var(--border-color);
        }

        .download-loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(44, 90, 160, 0.2);
            border-top: 5px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .download-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-blue);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            align-items: center;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

        .download-notification i {
            margin-right: 10px;
        }

        /* Modal styles */
        .photo-modal .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
        }

        .photo-modal .modal-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .photo-modal .modal-body {
            padding: 0;
            background-color: var(--dark-bg);
        }

        .photo-modal .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            background-color: var(--darker-bg);
        }

        .photo-modal img {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
        }

        /* Upload Modal */
        .upload-modal .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
        }

        .upload-modal .modal-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .upload-modal .modal-body {
            background-color: var(--dark-bg);
        }

        .upload-modal .modal-footer {
            border-top: 1px solid var(--border-color);
            background-color: var(--darker-bg);
        }

        .upload-modal .form-control {
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            color: var(--light-text);
        }

        .upload-modal .form-control:focus {
            background: var(--darker-bg);
            color: var(--light-text);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }

        .upload-modal .custom-file-label {
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            color: var(--light-text);
        }

        .upload-modal .custom-file-input:focus ~ .custom-file-label {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }

        /* Progress bar */
        .upload-progress-wrapper {
            background: var(--darker-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .progress {
            background-color: var(--dark-bg);
            height: 8px;
            border-radius: 4px;
        }

        .progress-bar-fill {
            background-color: var(--primary-blue);
            border-radius: 4px;
        }

        .progress-status, .progress-percent, .file-counter {
            color: var(--light-text);
            font-size: 0.85rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 0;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .empty-state i {
            font-size: 5rem;
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--lighter-text);
        }

        .empty-state p {
            color: var(--light-text);
            margin-bottom: 2rem;
            opacity: 0.7;
        }

        /* Confirmation Modal */
        .confirmation-modal .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
        }

        .confirmation-modal .modal-header {
            background: linear-gradient(90deg, var(--primary-blue), var(--accent-blue));
            color: white;
            border-bottom: 1px solid var(--border-color);
        }

        .confirmation-modal .modal-body {
            background-color: var(--dark-bg);
            color: var(--light-text);
        }

        .confirmation-modal .modal-footer {
            border-top: 1px solid var(--border-color);
            background-color: var(--darker-bg);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .photo-grid {
                grid-template-columns: 1fr;
            }

            .hero-title {
                font-size: 2.2rem;
            }

            .hero-subtitle {
                font-size: 1.1rem;
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>

<!-- Background Image -->
<div class="bg-fast-load">
    <img
            src="/img/album.webp"
            srcset="
      /img/album.webp?width=600 600w,
      /img/album.webp?width=1200 1200w,
      /img/album.webp?width=1800 1800w
    "
            sizes="100vw"
            alt=""
            decoding="async"
    >
</div>

<!-- Main Content -->
<div class="main-container">
    <div class="container-fluid px-5">
        <!-- Header Section -->
        <div class="hero-section">
            <h1 class="hero-title" th:text="#{photos}">Photos</h1>
            <p class="hero-subtitle" th:text="#{add-photo-description}">Add a new photo to the folders</p>

            <div class="action-buttons">
                <button type="button" class="btn-mega" onclick="window.history.back()">
                    <i class="fas fa-arrow-left btn-icon"></i> <span th:text="#{back}">Back</span>
                </button>

                <button class="btn-mega" data-toggle="modal" data-target="#subirFotoModal">
                    <i class="fas fa-plus-circle btn-icon"></i> <span th:text="#{add-photo}">Add photo</span>
                </button>
            </div>
        </div>

        <!-- Download actions -->
        <div class="download-actions">
            <div>
                <button class="btn-mega btn-success" id="downloadAllBtn">
                    <i class="fas fa-download btn-icon"></i> <span th:text="#{download-all}">Download All</span>
                </button>
                <button class="btn-mega btn-success download-selected" id="downloadSelectedBtn" disabled>
                    <i class="fas fa-download btn-icon"></i> <span th:text="#{download-selected}">Download Selected</span>
                </button>
                <button class="btn-mega btn-danger" id="deleteSelectedBtn" disabled th:if="${canEdit}">
                    <i class="fas fa-trash-alt btn-icon"></i> <span th:text="#{delete-selected}">Delete Selected</span>
                </button>
            </div>
            <span id="selectedCount" th:text="#{selected-count(0)}">0 selected</span>
        </div>

        <!-- Photo Gallery -->
        <div th:if="${not #lists.isEmpty(fotoDespues)}" class="photo-grid">
            <div th:each="fotoDespues : ${fotoDespues}" class="photo-card">
                <input type="checkbox" class="photo-checkbox" th:data-id="${fotoDespues.id}" th:data-url="@{/images/{img}(img=${fotoDespues.imagen})}" th:data-name="${fotoDespues.nombre}">
                <div class="photo-img-container">
                    <div th:if="${#strings.endsWith(fotoDespues.imagen, '.mp4') or #strings.endsWith(fotoDespues.imagen, '.avi') or #strings.endsWith(fotoDespues.imagen, '.mov') or #strings.endsWith(fotoDespues.imagen, '.mkv')}">
                        <video class="photo-img" controls>
                            <source th:src="@{/images/{img}(img=${fotoDespues.imagen})}" type="video/mp4">
                            <span th:text="#{browser-no-support-video}">Your browser does not support videos.</span>
                        </video>
                    </div>
                    <div th:unless="${#strings.endsWith(fotoDespues.imagen, '.mp4') or #strings.endsWith(fotoDespues.imagen, '.avi') or #strings.endsWith(fotoDespues.imagen, '.mov') or #strings.endsWith(fotoDespues.imagen, '.mkv')}">
                        <img class="photo-img" th:src="@{/images/{img}(img=${fotoDespues.imagen})}" alt="Foto del álbum">
                    </div>

                    <div class="photo-overlay">
                        <h5 class="photo-title" th:text="${fotoDespues.nombre}">Photo name</h5>
                        <h8 class="photo-uploader" th:text="#{uploaded-by(${fotoDespues.usuario.nombre})}">Uploaded by: User</h8>
                        <p class="photo-description" th:text="#{date-colon(${#dates.format(fotoDespues.fecha, 'dd/MM/yyyy HH:mm')})}">
                            Date: 01/01/2023 12:00
                        </p>
                    </div>
                </div>
                <div class="photo-content">
                    <div class="photo-actions">
                        <a href="javascript:void(0)" class="btn-mega btn-sm" data-toggle="modal" th:data-target="'#photoModal' + ${fotoDespues.id}">
                            <i class="fas fa-expand btn-icon"></i> <span th:text="#{enlarge}">Enlarge</span>
                        </a>
                        <a href="javascript:void(0)" class="btn-mega btn-sm btn-danger" th:data-id="${fotoDespues.id}" th:if="${canEdit}">
                            <i class="fas fa-trash-alt btn-icon"></i> <span th:text="#{delete}">Delete</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${#lists.isEmpty(fotoDespues)}" class="empty-state">
            <i class="far fa-images"></i>
            <h3 th:text="#{no-photos-in-project}">There are no photos in this project</h3>
            <p th:text="#{start-by-adding}">Start by adding photos to view them here</p>
        </div>
    </div>
</div>

<!-- Loading and Notifications -->
<div class="download-loading" id="downloadLoading">
    <div class="download-loading-content">
        <div class="download-loading-spinner"></div>
        <h4>Preparing your download...</h4>
        <p id="downloadProgressText">Downloading files: 0/0</p>
    </div>
</div>

<div class="download-loading" id="deleteLoading">
    <div class="download-loading-content">
        <div class="download-loading-spinner"></div>
        <h4>Deleting files...</h4>
        <p id="deleteProgressText">Deleting files: 0/0</p>
    </div>
</div>

<div class="download-notification" id="downloadNotification">
    <i class="fas fa-check-circle"></i>
    <span id="downloadNotificationText">Download complete!</span>
</div>

<div class="download-notification" id="deleteNotification">
    <i class="fas fa-check-circle"></i>
    <span id="deleteNotificationText">Delete complete!</span>
</div>

<!-- Confirmation Modals -->
<div class="modal fade confirmation-modal" id="confirmDownloadModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="#{confirm-download}">Confirm Download</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmDownloadText">
                <!-- Will be filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-mega" data-dismiss="modal" th:text="#{cancel}">Cancel</button>
                <button type="button" class="btn-mega btn-success" id="confirmDownloadBtn" th:text="#{download}">Download</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade confirmation-modal" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" th:text="#{confirm-delete}">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmDeleteText">
                <!-- Will be filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-mega" data-dismiss="modal" th:text="#{cancel}">Cancel</button>
                <button type="button" class="btn-mega btn-danger" id="confirmDeleteBtn" th:text="#{delete}">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Photo Modal -->
<div class="modal fade upload-modal" id="subirFotoModal" tabindex="-1" role="dialog" aria-labelledby="subirFotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="uploadForm" th:action="@{/fotos/save}" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="subirFotoModalLabel"><i class="fas fa-camera btn-icon"></i> <span th:text="#{upload-new-media}">Upload new photo or video</span></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="successMessage" class="alert alert-success d-none">
                        <i class="fas fa-check-circle"></i> <span th:text="#{photo-uploaded-success}">Photo uploaded successfully!</span>
                    </div>

                    <div id="formatError" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-circle"></i> <span id="formatErrorMessage"></span>
                    </div>

                    <div class="upload-progress-wrapper d-none mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="progress-status small">Uploading files...</span>
                            <span class="progress-percent small font-weight-bold">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-fill progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%;"></div>
                        </div>
                        <div class="text-right mt-1">
                            <small class="text-muted file-counter">File <span class="current-file-num">1</span> of <span class="total-files">0</span></small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="nombre" class="font-weight-bold" th:text="#{multimedia-names}">Multimedia names</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" th:placeholder="#{name-for-photo}" required>
                    </div>

                    <input type="hidden" name="subalbum" th:value="${subAlbum.id}" />
                    <input type="hidden" id="hora" name="hora" value="">

                    <div class="form-group">
                        <label for="img" class="font-weight-bold" th:text="#{select-image-video}">Select Image or Video</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="img" name="img" accept="image/*,video/*,.heic,.heif" multiple required>
                            <label class="custom-file-label" for="img" th:text="#{choose-files}">Choose file(s)</label>
                        </div>
                        <small class="form-text text-muted" th:text="#{you-can-select-multiple}">You can select multiple files at once</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-mega" data-dismiss="modal" th:text="#{cancel}">Cancel</button>
                    <button type="submit" class="btn-mega" id="submitBtn">
                        <span class="btn-text" th:text="#{upload}">Upload</span>
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Photo Modals -->
<div th:each="fotoDespues : ${fotoDespues}">
    <div class="modal fade photo-modal" th:id="'photoModal' + ${fotoDespues.id}" tabindex="-1" role="dialog"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" th:id="'photoModalLabel' + ${fotoDespues.id}" th:text="${fotoDespues.nombre}">Foto Detalle</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div th:if="${#strings.endsWith(fotoDespues.imagen, '.mp4') or #strings.endsWith(fotoDespues.imagen, '.avi') or #strings.endsWith(fotoDespues.imagen, '.mov') or #strings.endsWith(fotoDespues.imagen, '.mkv')}">
                        <video class="img-fluid video-content" id="videoModal" controls>
                            <source th:src="@{/images/{img}(img=${fotoDespues.imagen})}" type="video/mp4">
                            <span th:text="#{browser-no-support-video}">Your browser does not support videos.</span>
                        </video>
                    </div>
                    <div th:unless="${#strings.endsWith(fotoDespues.imagen, '.mp4') or #strings.endsWith(fotoDespues.imagen, '.avi') or #strings.endsWith(fotoDespues.imagen, '.mov') or #strings.endsWith(fotoDespues.imagen, '.mkv')}">
                        <img class="img-fluid" th:src="@{/images/{img}(img=${fotoDespues.imagen})}" alt="Foto detallada">
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="photo-uploader" th:text="#{uploaded-by(${fotoDespues.usuario.nombre})}">Uploaded by: User</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function() {
        // Formatos de archivo soportados
        const supportedFormats = {
            images: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'],
            videos: ['mp4', 'webm', 'ogg']
        };


        // Función para validar los formatos de archivo
        function validateFileFormats(files) {
            const invalidFiles = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const extension = file.name.split('.').pop().toLowerCase();
                const isImage = supportedFormats.images.includes(extension);
                const isVideo = supportedFormats.videos.includes(extension);

                if (!isImage && !isVideo) {
                    invalidFiles.push({
                        name: file.name,
                        extension: extension
                    });
                }
            }

            return invalidFiles;
        }

        // Set current time
        function setCurrentTime() {
            const now = new Date();
            document.getElementById('hora').value = now.toTimeString().substring(0, 5);
        }

        // Initialize modal behaviors
        function initModal() {
            // Set time on modal show
            $('#subirFotoModal').on('show.bs.modal', setCurrentTime);

            // Reset modal on close
            $('#subirFotoModal').on('hidden.bs.modal', function() {
                $(this).find('form')[0].reset();
                $(this).find('.custom-file-label').text('Choose file(s)');
                $('#successMessage').addClass('d-none');
                $('#formatError').addClass('d-none');

                // Pause any videos
                $(this).find('video').each(function() {
                    this.pause();
                    this.currentTime = 0;
                });
            });

            // Update file input label
            $('.custom-file-input').on('change', function() {
                const files = this.files;
                let label = 'Choose file(s)';

                if (files.length > 0) {
                    // Validar formatos de archivo
                    const invalidFiles = validateFileFormats(files);

                    if (invalidFiles.length > 0) {
                        // Mostrar mensaje de error
                        const errorMessage = invalidFiles.length === 1
                            ? `The file format .${invalidFiles[0].extension} is not supported. Please select a valid image or video file.`
                            : `The following file formats are not supported: ${invalidFiles.map(f => `.${f.extension}`).join(', ')}. Please select valid image or video files.`;

                        $('#formatErrorMessage').text(errorMessage);
                        $('#formatError').removeClass('d-none');

                        // Resetear el input de archivo
                        $(this).val('');
                        $(this).next('.custom-file-label').text('Choose file(s)');
                        return;
                    } else {
                        // Ocultar mensaje de error si estaba visible
                        $('#formatError').addClass('d-none');
                    }

                    if (files.length === 1) {
                        label = files[0].name;
                    } else {
                        label = `${files.length} files selected`;
                    }
                }

                $(this).next('.custom-file-label').text(label);
            });
        }

        // AJAX form submission
        function initUploadForm() {
            $('#uploadForm').on('submit', function(e) {
                e.preventDefault();
                const form = this;
                const files = $('#img')[0].files;

                // Validar formatos antes de enviar
                const invalidFiles = validateFileFormats(files);
                if (invalidFiles.length > 0) {
                    const errorMessage = invalidFiles.length === 1
                        ? `The file format .${invalidFiles[0].extension} is not supported. Please select a valid image or video file.`
                        : `The following file formats are not supported: ${invalidFiles.map(f => `.${f.extension}`).join(', ')}. Please select valid image or video files.`;

                    $('#formatErrorMessage').text(errorMessage);
                    $('#formatError').removeClass('d-none');
                    return;
                }

                const formData = new FormData(form);
                const totalFiles = files.length;

                // UI updates
                const progressWrapper = $('.upload-progress-wrapper');
                const submitBtn = $('#submitBtn');
                const btnText = submitBtn.find('.btn-text');
                const spinner = submitBtn.find('.spinner-border');

                progressWrapper.removeClass('d-none');
                $('.total-files').text(totalFiles);
                $('.current-file-num').text('1');
                $('.progress-bar-fill').css('width', '0%');
                $('.progress-percent').text('0%');

                submitBtn.prop('disabled', true);
                btnText.text('Uploading...');
                spinner.removeClass('d-none');

                // AJAX request
                $.ajax({
                    url: $(form).attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhr: function() {
                        const xhr = new XMLHttpRequest();

                        xhr.upload.addEventListener('progress', function(e) {
                            if (e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);

                                $('.progress-bar-fill').css('width', percent + '%');
                                $('.progress-percent').text(percent + '%');

                                if (totalFiles > 1) {
                                    const currentFile = Math.min(Math.floor(percent / (100 / totalFiles)) + 1, totalFiles);
                                    $('.current-file-num').text(currentFile);
                                }
                            }
                        });

                        return xhr;
                    },
                    success: function(response) {
                        // Success handling
                        $('.progress-status').text('Upload complete!');
                        $('.progress-bar-fill').removeClass('progress-bar-animated');

                        // Show success message
                        $('#successMessage').removeClass('d-none');

                        // Close modal after 1.5 seconds
                        setTimeout(() => {
                            $('#subirFotoModal').modal('hide');

                            // If there's a redirect URL in the response
                            if (response.redirect) {
                                window.location.href = response.redirect;
                            } else {
                                // Reload page after closing modal
                                setTimeout(() => location.reload(), 500);
                            }
                        }, 1500);
                    },
                    error: function(xhr) {
                        // Error handling
                        $('.progress-status').text('Upload failed').addClass('text-danger');
                        $('.progress-bar-fill').css('background-color', '#dc3545');

                        setTimeout(() => {
                            progressWrapper.addClass('d-none');
                            submitBtn.prop('disabled', false);
                            btnText.text('Upload');
                            spinner.addClass('d-none');

                            // Reset progress bar
                            $('.progress-bar-fill').css({
                                'width': '0%',
                                'background-color': '#4e73df'
                            }).addClass('progress-bar-animated');
                            $('.progress-status').text('Uploading files...').removeClass('text-danger');
                        }, 3000);

                        // Show error message
                        const errorMsg = xhr.responseJSON?.message || 'An error occurred during upload';
                        alert(`Error: ${errorMsg}`);
                    }
                });
            });
        }

        // Helper function to get file extension
        function getFileExtension(url) {
            const lastDot = url.lastIndexOf('.');
            if (lastDot === -1) return '';
            return url.substring(lastDot);
        }

        // Function to generate unique filename
        function generateUniqueFilename(originalName, url, index = 0) {
            const timestamp = new Date().getTime();
            const randomString = Math.random().toString(36).substring(2, 8);
            return `${originalName}_${timestamp}_${randomString}_${index}${getFileExtension(url)}`;
        }

        // Function to show notification
        function showNotification(message, type = 'success', isDelete = false) {
            const notification = isDelete ? $('#deleteNotification') : $('#downloadNotification');
            const notificationText = isDelete ? $('#deleteNotificationText') : $('#downloadNotificationText');

            // Set notification style based on type
            if (type === 'error') {
                notification.css('background', '#dc3545');
                notification.find('i').removeClass('fa-check-circle').addClass('fa-exclamation-circle');
            } else {
                notification.css('background', 'var(--primary-color)');
                notification.find('i').removeClass('fa-exclamation-circle').addClass('fa-check-circle');
            }

            notificationText.text(message);
            notification.fadeIn();

            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.fadeOut();
            }, 3000);
        }

        // Function to delete a single photo - MODIFICADO PARA HTTPS
        function deleteSinglePhoto(photoId) {
            $.ajax({
                url: '/fotos/delete/' + photoId,
                type: 'DELETE', // Cambiado a DELETE
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') // Añadir CSRF para seguridad
                },
                success: function(response) {
                    showNotification('Photo deleted successfully', 'success', true);
                    $(`.photo-checkbox[data-id="${photoId}"]`).closest('.photo-card').remove();
                    if ($('.photo-card').length === 0) {
                        setTimeout(() => location.reload(), 500);
                    }
                },
                error: function(xhr) {
                    showNotification('Error deleting photo', 'error', true);
                }
            });
        }

        // Function to delete multiple photos - MODIFICADO PARA HTTPS
        function deleteMultiplePhotos(photoIds) {
            const deleteOverlay = $('#deleteLoading');
            const progressText = $('#deleteProgressText');
            const totalPhotos = photoIds.length;

            deleteOverlay.css('display', 'flex');
            progressText.text(`Deleting files: 0/${totalPhotos}`);

            let successCount = 0;

            photoIds.forEach((photoId, index) => {
                setTimeout(() => {
                    progressText.text(`Deleting files: ${index + 1}/${totalPhotos}`);

                    $.ajax({
                        url: '/fotos/delete/' + photoId,
                        type: 'DELETE', // Cambiado a DELETE
                        headers: {
                            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') // Añadir CSRF para seguridad
                        },
                        success: function(response) {
                            successCount++;
                            $(`.photo-checkbox[data-id="${photoId}"]`).closest('.photo-card').remove();

                            if (index === photoIds.length - 1) {
                                setTimeout(() => {
                                    deleteOverlay.hide();
                                    showNotification(`Successfully deleted ${successCount} file${successCount > 1 ? 's' : ''}`, 'success', true);
                                    if ($('.photo-card').length === 0) {
                                        setTimeout(() => location.reload(), 500);
                                    }
                                }, 500);
                            }
                        },
                        error: function(xhr) {
                            console.error('Error deleting photo with ID:', photoId);
                            if (index === photoIds.length - 1) {
                                setTimeout(() => {
                                    deleteOverlay.hide();
                                    showNotification(`Deleted ${successCount} of ${totalPhotos} files`, successCount === totalPhotos ? 'success' : 'error', true);
                                }, 500);
                            }
                        }
                    });
                }, index * 300);
            });
        }

        // New code for download and delete functionality
        function initDownloadAndDeleteFunctions() {
            let selectedPhotos = [];
            let currentDownloadQueue = [];

            // Handle checkbox selection
            $('.photo-grid').on('change', '.photo-checkbox', function() {
                const photoId = $(this).data('id');
                const photoUrl = $(this).data('url');
                const photoName = $(this).data('name');
                const isChecked = $(this).is(':checked');

                // Toggle selected class on card
                $(this).closest('.photo-card').toggleClass('selected', isChecked);

                // Update selected photos array
                if (isChecked) {
                    selectedPhotos.push({ id: photoId, url: photoUrl, name: photoName });
                } else {
                    selectedPhotos = selectedPhotos.filter(photo => photo.id !== photoId);
                }

                // Update UI
                $('#selectedCount').text(selectedPhotos.length + ' selected');
                $('#downloadSelectedBtn').prop('disabled', selectedPhotos.length === 0);
                $('#deleteSelectedBtn').prop('disabled', selectedPhotos.length === 0);
            });

            // Download all photos
            $('#downloadAllBtn').on('click', function() {
                const photos = [];
                $('.photo-checkbox').each(function() {
                    photos.push({
                        url: $(this).data('url'),
                        name: $(this).data('name')
                    });
                });

                if (photos.length > 0) {
                    // Use translation for confirmation text, passing count and using a ternary for plural 's'
                    $('#confirmDownloadText').html(
                        translations.confirm_download_text
                            .replace('{0}', `<strong>${photos.length}</strong>`)
                            .replace('{1}', photos.length > 1 ? 's' : '') // 's' for plural, empty for singular
                    );
                    $('#confirmDownloadBtn').off('click').on('click', function() {
                        $('#confirmDownloadModal').modal('hide');
                        downloadMultipleFiles(photos);
                    });
                    $('#confirmDownloadModal').modal('show');
                } else {
                    // Use translation for "No files available to download"
                    showNotification(translations.no_files_available, 'error');
                }
            });

            // Download selected photos
            $('#downloadSelectedBtn').on('click', function() {
                if (selectedPhotos.length > 0) {
                    // Use translation for confirmation text, passing count and using a ternary for plural 's'
                    $('#confirmDownloadText').html(
                        translations.confirm_download_text
                            .replace('{0}', `<strong>${selectedPhotos.length}</strong>`)
                            .replace('{1}', selectedPhotos.length > 1 ? 's' : '') // 's' for plural, empty for singular
                    );
                    $('#confirmDownloadBtn').off('click').on('click', function() {
                        $('#confirmDownloadModal').modal('hide');
                        downloadMultipleFiles(selectedPhotos);
                    });
                    $('#confirmDownloadModal').modal('show');
                } else {
                    // Use translation for "Please select at least one file to download"
                    showNotification(
                        translations.select_at_least_one.replace('{0}', translations.download),
                        'error'
                    );
                }
            });

            // Delete selected photos
            $('#deleteSelectedBtn').on('click', function() {
                if (selectedPhotos.length > 0) {
                    // Use translation for confirmation text, passing count and using a ternary for plural 's'
                    $('#confirmDeleteText').html(
                        translations.confirm_delete_text
                            .replace('{0}', `<strong>${selectedPhotos.length}</strong>`)
                            .replace('{1}', selectedPhotos.length > 1 ? 's' : '') // 's' for plural, empty for singular
                    );
                    $('#confirmDeleteBtn').off('click').on('click', function() {
                        $('#confirmDeleteModal').modal('hide');
                        const photoIds = selectedPhotos.map(photo => photo.id);
                        deleteMultiplePhotos(photoIds);
                    });
                    $('#confirmDeleteModal').modal('show');
                } else {
                    // Use translation for "Please select at least one file to delete"
                    showNotification(
                        translations.select_at_least_one.replace('{0}', translations.delete),
                        'error',
                        true
                    );
                }
            });

            // Handle single photo delete
            $('.photo-card, .photo-modal').on('click', '.btn-delete-single', function(e) {
                e.preventDefault();
                const photoId = $(this).data('id');

                // Show confirmation modal
                $('#confirmDeleteText').html(
                    translations.confirm_delete_text
                        .replace('{0}', '') // No specific file count here
                        .replace('{1}', '') // No 's' for plural here
                        .replace('You are about to delete ', '') // Remove this part
                    + translations.this_file_cannot_be_undone // New specific string
                );


                $('#confirmDeleteBtn').off('click').on('click', function() {
                    $('#confirmDeleteModal').modal('hide');
                    deleteSinglePhoto(photoId);
                });
                $('#confirmDeleteModal').modal('show');
            });

            // Function to download multiple files
            function downloadMultipleFiles(files) {
                if (files.length === 0) return;

                currentDownloadQueue = files;
                const loadingOverlay = $('#downloadLoading');
                const progressText = $('#downloadProgressText');

                // Show loading overlay
                loadingOverlay.css('display', 'flex');
                progressText.text(`Downloading files: 0/${files.length}`);

                // Download each file with a small delay between them
                files.forEach((file, index) => {
                    setTimeout(() => {
                        // Update progress
                        progressText.text(`Downloading files: ${index + 1}/${files.length}`);

                        // Generate unique filename
                        const uniqueName = generateUniqueFilename(file.name, file.url, index);

                        // Create invisible download link
                        const link = document.createElement('a');
                        link.href = file.url;
                        link.download = uniqueName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // If it's the last file, close overlay and show notification
                        if (index === files.length - 1) {
                            setTimeout(() => {
                                loadingOverlay.hide();
                                showNotification(`Successfully downloaded ${files.length} file${files.length > 1 ? 's' : ''}`);
                            }, 500);
                        }
                    }, index * 300); // Small delay between downloads
                });
            }
        }

        // Initialize everything
        setCurrentTime();
        initModal();
        initUploadForm();
        initDownloadAndDeleteFunctions();
    });


</script>

</body>
</html>